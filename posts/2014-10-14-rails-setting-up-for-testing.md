---
title:  "Rails: Setting Up for Testing"
date:   2014-10-14
summary: "As I started work on a new Rails project recently, one of my first priorities was to set up my test environment and tools so I could use test driven development (TDD) from the beginning. Here are the steps I took, some snags I ran into, and some things I learned along the way..."
tags: 
  - Ruby 
  - Rails 
  - TDD
---
As I started work on a new Rails project recently, one of my first priorities was to set up my test environment and tools so I could use test driven development (TDD) from the beginning. Here are the steps I took, some snags I ran into, and some things I learned along the way.

My first step was to modify my Gemfile. I replaced 'sqlite3' with 'pg' for my database. I'll be deploying to Heroku, and I want my development and test environment to be as close to production as possible. (I added 'rails_12factor' and 'unicorn' while I was at it. I'll need them for deployment anyway...) I also added 'figaro' to manage my environment variables.

Specifically for testing, I added:
<pre class="highlight"><code><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
 <span class="n">gem</span> <span class="s1">'factory_girl_rails'</span>
 <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'~&lt; 3.0.0.beta'</span>
 <span class="n">gem</span> <span class="s1">'capybara'</span><span class="p">,</span> <span class="s1">'~&lt; 2.4.3'</span> <span class="c1"># To simulate user interaction with browser</span>
 <span class="n">gem</span> <span class="s1">'capybara-webkit'</span> <span class="c1"># For pages with JavaScript - so they load in real webpage</span>
 <span class="n">gem</span> <span class="s1">'database_cleaner'</span> <span class="c1"># To clean database after capybara-webkit messes it up</span>
 <span class="n">gem</span> <span class="s1">'debugger'</span>
 <span class="n">gem</span> <span class="s1">'launchy'</span>
<span class="k">end</span>
</code></pre>
After running <code>bundle install </code>and <code>rails g rspec:install,</code> I noticed something interesting. My spec folder had the spec_helper.rb file I expected, but it also had a new file I'd never seen before - rails_helper.rb. Some Googling revealed that rails_helper.rb is basically what spec_helper.rb used to be, and spec_helper.rb has been stripped down. The <a title="Relish App Rspec Documentation" href="https://www.relishapp.com/rspec/rspec-rails/docs/upgrade" target="_blank">docs</a> explained that spec_helper.rb now matches the file that's generated by Rspec when it's used on it's own (without Rails), and it provides a way to run tests that don't require Rails without loading Rails up. Cool.

The only change I made to spec_helper.rb was to uncomment the line about running specs in random order, which magically uncommented the other defaults as well. The defaults were what I wanted, so I left them alone. I had a little more work to do in rails_helper.rb though. With my additions, the top of the file now looks like this:
<pre class="highlight"><code><span class="no">ENV</span><span class="p">[</span><span class="s2">"RAILS_ENV"</span><span class="p">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s2">"../../config/environment"</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span>
<span class="nb">require</span> <span class="s1">'rspec/rails'</span>
<span class="nb">require</span> <span class="s1">'capybara/rails'</span>
<span class="nb">require</span> <span class="s1">'capybara/rspec'</span>
<span class="nb">require</span> <span class="s1">'database_cleaner'</span>
</code></pre>
I remembered from a past project that I needed a different driver for tests with JavaScript, and I needed to configure database_cleaner differently depending on the type of test, too. I couldn't remember exactly how to do it, though. At first I copied and pasted the code from my older project, but there were a couple of things that looked fishy, so I started reading up on those topics again. I was glad I did, because my old project had some redundancies and things that just didn't make sense upon closer inspection. For the new project, I set up <a title="Capybara-Webkit Documentation" href="https://github.com/thoughtbot/capybara-webkit" target="_blank">capybara-webkit</a> as the driver for JS tests and configured <a title="Database Cleaner Documentation" href="https://github.com/DatabaseCleaner/database_cleaner" target="_blank">database-cleaner</a> to use a truncation strategy for tests with JavaScript and transaction for everything else. This is what I ended up addinginside the Rspec.configure block:
<pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>    <span class="c1"># Use capybara-webkit for tests with JavaScript</span>
 <span class="no">Capybara</span><span class="p">.</span><span class="nf">javascript_driver</span> <span class="o">=</span> <span class="ss">:webkit</span>

 <span class="c1"># Setup for database cleaning between tests</span>
 <span class="c1"># Different strategy needed for testing with JavaScript</span>
 <span class="n">config</span><span class="p">.</span><span class="nf">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
  <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">strategy</span> <span class="o">=</span> <span class="n">example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:js</span><span class="p">]</span> <span class="p">?</span> <span class="ss">:truncation</span> <span class="p">:</span> <span class="ss">:transaction</span>
  <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">start</span>
 <span class="k">end</span>
 <span class="n">config</span><span class="p">.</span><span class="nf">after</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">clean</span>
 <span class="n">endend</span>
</code></pre>
I edited config/database.yml to use postgres instead of sqlite. Otherwise, I left the defaults in place, including the database names. That turned out to be a mistake, though I didn't realize it until later. After I created my first models - including a User model - and ran rake <code>db:migrate,</code> I got an error that the User table already existed. I'd forgotten that postgres databases aren't contained within individual Rails projects. All of my projects use Postgres.app as the common server. I used the default database names on another project, so now my new project thought it was supposed to use the same database and threw an error when I tried to create a new User table in a database that already had one. I changed the database names for development and testing, but I left the production settings as they were. I probably should have changed them too just to be thorough, but I know Heroku overwrites that file with its own settings on deployment. This is what my database.yml file looked like after I made all the changes:
<pre class="highlight"><code><span class="ss">production:
 adapter: </span><span class="n">postgresql</span>
 <span class="ss">encoding: </span><span class="n">unicode</span>
 <span class="ss">database: </span><span class="n">db</span><span class="o">/</span><span class="n">production</span>
 <span class="ss">pool: </span><span class="mi">5</span>
 <span class="ss">timeout: </span><span class="mi">5000</span>

<span class="ss">development:
 adapter: </span><span class="n">postgresql</span>
 <span class="ss">encoding: </span><span class="n">unicode</span>
 <span class="ss">database: </span><span class="n">db</span><span class="o">/</span><span class="n">preschool_development</span>
 <span class="ss">pool: </span><span class="mi">5</span>
 <span class="ss">timeout: </span><span class="mi">5000</span>

<span class="c1"># Warning: The database defined as "test" will be erased and</span>
<span class="c1"># re-generated from your development database when you run "rake".</span>
<span class="c1"># Do not set this db to the same as development or production.</span>
<span class="ss">test:
 adapter: </span><span class="n">postgresql</span>
 <span class="ss">encoding: </span><span class="n">unicode</span>
 <span class="ss">database: </span><span class="n">db</span><span class="o">/</span><span class="n">preschool_test</span>
 <span class="ss">pool: </span><span class="mi">5</span>
 <span class="ss">timeout: </span><span class="mi">5000</span>
</code></pre>
After I created and migrated the database successfully, I thought I was ready to go. I wrote a simple spec and tried to run it in the Terminal just to confirm that everything was working, but my Terminal screen blew up with the longest error message I'd ever seen. Something about circular loading of spec_helper.rb... Much searching later, I learned that the problem was in the .rspec file. I needed to delete the line there requiring spec_helper. I took out the warnings line, too. That could be dangerous, but Stack Overflow posts suggested it, and an open source project I've worked on had it taken out as well. I have a lot of faith in the person who set up that project, so I figured it would be safe to follow suit.

After taking out those lines, my spec ran as expected. I was finally ready for some TDD.